<Project>
  <!-- This file defines the MSBuild targets for Lambda.GraphQL -->
  
  <PropertyGroup>
    <GraphQLSchemaOutputDirectory Condition="'$(GraphQLSchemaOutputDirectory)' == ''">$(MSBuildProjectDirectory)</GraphQLSchemaOutputDirectory>
    <GraphQLSchemaFileName Condition="'$(GraphQLSchemaFileName)' == ''">schema.graphql</GraphQLSchemaFileName>
    <GraphQLResolverFileName Condition="'$(GraphQLResolverFileName)' == ''">resolvers.json</GraphQLResolverFileName>
    <EnableLambdaGraphQLSchemaGeneration Condition="'$(EnableLambdaGraphQLSchemaGeneration)' == ''">true</EnableLambdaGraphQLSchemaGeneration>
  </PropertyGroup>

  <UsingTask TaskName="Lambda.GraphQL.Build.ExtractGraphQLSchemaTask" 
             AssemblyFile="$(MSBuildThisFileDirectory)../tools/Lambda.GraphQL.Build.dll" 
             Condition="Exists('$(MSBuildThisFileDirectory)../tools/Lambda.GraphQL.Build.dll')" />

  <!-- Development scenario: project reference - try current configuration -->
  <UsingTask TaskName="Lambda.GraphQL.Build.ExtractGraphQLSchemaTask" 
             AssemblyFile="$(MSBuildThisFileDirectory)../../Lambda.GraphQL.Build/bin/$(Configuration)/net6.0/Lambda.GraphQL.Build.dll" 
             Condition="!Exists('$(MSBuildThisFileDirectory)../tools/Lambda.GraphQL.Build.dll') AND Exists('$(MSBuildThisFileDirectory)../../Lambda.GraphQL.Build/bin/$(Configuration)/net6.0/Lambda.GraphQL.Build.dll')" />
  
  <!-- Fallback to Release if current configuration doesn't exist -->
  <UsingTask TaskName="Lambda.GraphQL.Build.ExtractGraphQLSchemaTask" 
             AssemblyFile="$(MSBuildThisFileDirectory)../../Lambda.GraphQL.Build/bin/Release/net6.0/Lambda.GraphQL.Build.dll" 
             Condition="!Exists('$(MSBuildThisFileDirectory)../tools/Lambda.GraphQL.Build.dll') AND !Exists('$(MSBuildThisFileDirectory)../../Lambda.GraphQL.Build/bin/$(Configuration)/net6.0/Lambda.GraphQL.Build.dll') AND Exists('$(MSBuildThisFileDirectory)../../Lambda.GraphQL.Build/bin/Release/net6.0/Lambda.GraphQL.Build.dll')" />
  
  <!-- Fallback to Debug if neither current nor Release exist -->
  <UsingTask TaskName="Lambda.GraphQL.Build.ExtractGraphQLSchemaTask" 
             AssemblyFile="$(MSBuildThisFileDirectory)../../Lambda.GraphQL.Build/bin/Debug/net6.0/Lambda.GraphQL.Build.dll" 
             Condition="!Exists('$(MSBuildThisFileDirectory)../tools/Lambda.GraphQL.Build.dll') AND !Exists('$(MSBuildThisFileDirectory)../../Lambda.GraphQL.Build/bin/$(Configuration)/net6.0/Lambda.GraphQL.Build.dll') AND !Exists('$(MSBuildThisFileDirectory)../../Lambda.GraphQL.Build/bin/Release/net6.0/Lambda.GraphQL.Build.dll') AND Exists('$(MSBuildThisFileDirectory)../../Lambda.GraphQL.Build/bin/Debug/net6.0/Lambda.GraphQL.Build.dll')" />

  <!-- Additional fallback for different project structures -->
  <UsingTask TaskName="Lambda.GraphQL.Build.ExtractGraphQLSchemaTask" 
             AssemblyFile="$(OutputPath)Lambda.GraphQL.Build.dll" 
             Condition="!Exists('$(MSBuildThisFileDirectory)../tools/Lambda.GraphQL.Build.dll') AND !Exists('$(MSBuildThisFileDirectory)../../Lambda.GraphQL.Build/bin/$(Configuration)/net6.0/Lambda.GraphQL.Build.dll') AND !Exists('$(MSBuildThisFileDirectory)../../Lambda.GraphQL.Build/bin/Release/net6.0/Lambda.GraphQL.Build.dll') AND !Exists('$(MSBuildThisFileDirectory)../../Lambda.GraphQL.Build/bin/Debug/net6.0/Lambda.GraphQL.Build.dll') AND Exists('$(OutputPath)Lambda.GraphQL.Build.dll')" />

  <Target Name="ExtractGraphQLSchema" 
          AfterTargets="Build" 
          Condition="'$(EnableLambdaGraphQLSchemaGeneration)' == 'true' AND '$(TargetPath)' != ''">
    
    <!-- Resolve output directory to full path -->
    <PropertyGroup>
      <_GraphQLOutputDir Condition="'$(GraphQLSchemaOutputDirectory)' != ''">$([System.IO.Path]::GetFullPath('$(GraphQLSchemaOutputDirectory)', '$(MSBuildProjectDirectory)'))</_GraphQLOutputDir>
      <_GraphQLOutputDir Condition="'$(_GraphQLOutputDir)' == ''">$(MSBuildProjectDirectory)</_GraphQLOutputDir>
    </PropertyGroup>
    
    <Message Text="Lambda.GraphQL: Extracting schema from $(TargetPath) to $(_GraphQLOutputDir)" Importance="high" />
    
    <ExtractGraphQLSchemaTask AssemblyPath="$(TargetPath)"
                              OutputDirectory="$(_GraphQLOutputDir)"
                              IntermediateOutputPath="$(IntermediateOutputPath)"
                              CompilerGeneratedFilesOutputPath="$(CompilerGeneratedFilesOutputPath)"
                              SchemaFileName="$(GraphQLSchemaFileName)"
                              ResolverFileName="$(GraphQLResolverFileName)" />
    
  </Target>

</Project>
